define(["jquery","editor","realTimeSocket"],function(e,t,n){"use strict";function o(t){var n,o=e(t.content);if(o.hide(),t.parentId){var i=e("#comment-"+t.parentId);(n=i.children(".children")).length?n.append(o):((n=e('<div class="children" />')).append(o),i.append(n));var s=i.find(".comment-all-link");s.length&&(s.data("show",s.data("show").replace(/\(.*\)/i,"("+t.numComment+")")),s.attr("data-show",s.data("show").replace(/\(.*\)/i,"("+t.numComment+")")),s.text(s.text().replace(/\(.*\)/i,"("+t.numComment+")")))}else e("#comments-list-"+t.threadId).prepend(o);o.slideDown("slow"),e("#comments-thread-title-"+t.threadId).html(t.contentSecond)}var i=function(t){this.$element="object"==typeof t?t:e(t),this.$form=this.$element.children("form"),this.reply=".comment-reply",this.showAll=".comment-all",this.save="#un_comment_comment_save",this.text='[name="un_comment_comment[body]"]',this.parent='[name="un_comment_comment[parent]"]',this.$cancelCommentReply=e('           <span class="cancel-comment-reply-link btn-muted p-0 btn-lg" role="button">                <svg class="icon icon-close">                    <use xlink:href="#icon-close"></use>                </svg>            </span>'),this.$btnCancelCommentReply=this.$form.find("#un_comment_comment_cancel"),this.init()};i.prototype={init:function(){this.$element.off("click"),this.$element.on("click",this.reply,this.commentReply.bind(this)),this.$element.off("requireajax.un.show"),this.$element.on("requireajax.un.show",this.showAll,this.showCommentAll.bind(this)),this.$element.on("requireajax.un.show",this.save,this.responseCreateComment.bind(this))},responseCreateComment:function(t){t.preventDefault();var n,i=t.response,s={relatedTarget:this};e(document).trigger(e.Event("comment.un.show",s)),n=e(i.parentId?"#comment-"+i.parentId:"#comments-list-"+i.threadId),e("html,body").stop().animate({scrollTop:n.offset().top-200},1e3).promise().then(function(){o(i),e(document).trigger(e.Event("comment.un.shown",s))}),this.$form.find(this.text).val(""),this.$cancelCommentReply.trigger("click"),this.$btnCancelCommentReply.trigger("click"),this.responseRealTime(i)},showCommentAll:function(t){var n=e(t.target),o=t.relatedTarget.$container,i=[];o.off("requireajax.un.shown"),o.on("requireajax.un.shown",function(){o.closest(".children").find(".comment").each(function(){i.indexOf(e(this).data("id"))<0?i.push(e(this).data("id")):e("#comment-"+e(this).data("id")).remove()}),n.off("click"),n.on("click",function(){o.stop(!0).slideToggle("fast",function(){e(this).is(":visible")?(n.children(".comment-all-link").html(n.children(".comment-all-link").data("hide")),n.find(".icon-arrow-down").removeClass("icon-arrow-down").addClass("icon-arrow-up").children().attr("href","#icon-arrow-up")):(n.children(".comment-all-link").html(n.children(".comment-all-link").data("show")),n.find(".icon-arrow-up").removeClass("icon-arrow-up").addClass("icon-arrow-down").children().attr("href","#icon-arrow-down"))})})}),window.setTimeout(function(){n.trigger("click")},200),n.removeAttr("data-ajax-request"),o.hide()},commentReply:function(t){var n=e(t.target);this.$form.find(this.parent).val(n.closest(".comment").data("id")),this.$form.insertAfter(n.closest(".comment").children(".comment-body")),this.$form.find(this.text).trigger("focus"),this.$btnCancelCommentReply.length?(this.$btnCancelCommentReply.removeClass("d-none"),this.$btnCancelCommentReply.off("click.un.cancelComment"),this.$btnCancelCommentReply.one("click.un.cancelComment",this.cancelCommentReply.bind(this))):(this.$form.append(this.$cancelCommentReply),this.$cancelCommentReply.off("click.un.cancelComment"),this.$cancelCommentReply.one("click.un.cancelComment",this.cancelCommentReply.bind(this)))},cancelCommentReply:function(t){this.$form.find(this.parent).val(0),this.$form.prependTo(e(t.target).closest(".comments")),this.$btnCancelCommentReply.length?this.$btnCancelCommentReply.addClass("d-none"):this.$cancelCommentReply.remove()},responseRealTime:function(e){n.emit("thread",{room:e.threadId,response:e})}};var s=function(){};return s.prototype={response:function(t){var n={relatedTarget:this};e.ajax({dataType:"json",url:t.response.urlComment,method:"GET",data:{view:"tree"}}).then(function(t){"success"===t.status&&(o(t),e(document).trigger(e.Event("comment.un.shown",n)))}.bind(this))}},e(document).on("requireajax.un.shown","#begin-comments",function(){new i(".comments")}),e(document).on("shown.un.modal","#popup-complaint-comment",function(){e(this).find("#un_complaint_complaint_type").on("change",function(){e(this).val()?e(this).closest("form").find("textarea").addClass("d-none"):e(this).closest("form").find("textarea").removeClass("d-none")})}).on("hide.bs.modal","#popup-complaint-comment",function(){e(this).find("#un_complaint_complaint_type").off("change")}),e(document).on("click","[data-bbcode]",function(){var n=e(this).closest("form").find(".editor-area"),o=t.getSelection(n),i=e(this).data("bbcode").replace(/{value}/i,o.text).replace(/{id}/i,e(this).data("id"));t.replaceSelection(n,i)}).on("click",".editor-smilies img",function(){var n=e(this).closest("form").find(".editor-area");t.replaceSelection(n,e(this).attr("alt")),e(this).closest("form").find(".editor-controls .smilies").data("speed","fast").trigger("click")}).on("requireajax.un.show",".editor-controls .smilies",function(t){var n=t.relatedTarget,o=t.response;t.preventDefault(),n.setLoaded(!0),n.$container.hide(),n.setContent(e(o.content)),n.$container.slideDown("slow")}).on("requireajax.un.start",".smilies",function(e){var t=e.relatedTarget;if(t.isLoaded()){var n=t.$element.data("speed")?t.$element.data("speed"):"slow";t.$element.data("speed","slow"),t.$container.stop(!0).slideToggle(n)}}).on("click",".editor-controls .smilies",function(){e(this).hasClass("disabled")||e(this).toggleClass("active")}),new s});