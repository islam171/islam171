define(["jquery","loader","cookie","modal","bootstrap","plagins"],function(t,e,o,n){"use strict";function i(t,e,o){!t.data("ajaxUNRequest")||t.attr("data-ajax-reinit")?(t.data("ajaxUNRequest",new s({element:t,container:t.data("ajax-container"),containerUnwrap:t.data("ajax-container-unwrap"),secondContainer:t.data("ajax-second-container"),secondContainerUnwrap:t.data("ajax-second-container-unwrap"),secondContainerRemove:t.data("ajax-second-container-remove"),containerClear:t.data("ajax-container-clear"),loaded:!0===o,reverse:t.data("loaded-scroll-reverse"),params:{url:t.attr("data-ajax-url"),method:t.data("ajax-method")?t.data("ajax-method"):"GET",dataType:t.data("ajax-type")?t.data("ajax-type"):"json",data:t.data("ajax-appear-params")},append:t.data("ajax-append"),replaceUrl:t.data("replace-url"),notification:t.data("notification"),notificationError:t.data("notification-error"),loadingText:t.data("loading-text"),top:t.data("ajax-scroll-top")||t.data("ajax-scroll-top")<=0?t.data("ajax-scroll-top"):100,loader:{id:!0===t.data("loader")?t:t.data("loader"),style:t.data("loader-style"),idloader:t.data("loader-idloader"),overlay:t.data("loader-overlay"),prepend:t.data("loader-prepend"),className:t.data("loader-classname")}})),t.data("ajax-request-begin-scroll")?t.data("ajaxUNRequest").scroll():t.data("ajaxUNRequest").ajax()):e&&!t.data("ajaxUNRequest").isProcessing()&&t.data("ajaxUNRequest").ajax()}var a={},s=function(e){this.options=t.extend({},s.Default,e),this.$element=this.options.element instanceof t?this.options.element:t(this.options.element),this.loader=null,this.$popover=null,this._url=null,this.processing=!1,this.loaded=!1,this.$popoverReload=null,this.MAX_UID=1e6,this.ariaDescribedby=~~(Math.random()*this.MAX_UID)};return s.Default={element:null,container:!1,containerUnwrap:!1,secondContainer:!1,secondContainerUnwrap:!1,secondContainerRemove:!1,containerClear:!1,top:100,loaded:!1,reverse:!1,params:{url:!1,method:"GET",dataType:"json",data:{}},append:!1,replaceUrl:!1,notification:!1,notificationError:"modal",loadingText:!1,loader:{id:!1,idloader:"uloader",overlay:!1,style:!1,className:!1,prepend:!1},beforeAjax:function(){},afterAjax:function(){},error:function(){}},s.prototype={init:function(){t("[data-ajax-request-begin]").each(function(){i(t(this))})},dataAjax:function(e){i(t(e),!0)},scroll:function(){this.$element.offset().top-t(window).innerHeight()+this.$element.height()<=t(window).scrollTop()+this.options.top?this.ajax():t(window).on("scroll.un.ajax"+this.ariaDescribedby,function(){(this.$element.offset().top-t(window).innerHeight()+this.$element.height()<=t(window).scrollTop()+this.options.top||t(window).innerHeight()+t(window).scrollTop()>this.$element.offset().top)&&(t(window).off("scroll.un.ajax"+this.ariaDescribedby),t(window).off("resize.un.ajax"+this.ariaDescribedby),this.ajax())}.bind(this))},getParams:function(){if("object"==typeof this.options.container&&this.options.container.length?this.$container=this.options.container:this.options.container&&"string"==typeof this.options.container?this.$container=t(this.options.container):!1!==this.options.container&&(this.$container=this.$element),this.$secondContainer=!!this.options.secondContainer&&t(this.options.secondContainer),this.$container&&this.options.containerClear&&(!0===this.options.containerClear?(this.$container.off("scroll.un.loadedscroll"),this.$container.html("")):t(this.options.containerClear).off("scroll.un.loadedscroll").html("")),null!==this.$element&&(this.$popover=!!this.$element.attr("aria-describedby")&&t("#"+this.$element.attr("aria-describedby")),this.$popoverReload=!!this.$element.data("popover-reload")&&t('[aria-describedby="'+this.$element.closest(".popover").attr("id")+'"]')),this.$element&&"form"===this.$element.data("ajax-appear-params")&&(this.options.params.data=this.$element.closest("form").serialize()),this.options.params.url)return!0},ajax:function(){var e,o;e={relatedTarget:this},this.historyPage(),null!==this.$element&&(this.$element.trigger(o=t.Event("requireajax.un.start",e)),o.isDefaultPrevented())||this.getParams()&&("function"==typeof this.options.beforeAjax&&this.options.beforeAjax.call(this,this.options),this.isLoaded()||(this.setProcessing(!0),this.setLoader(!0),t.ajax(this.options.params).then(t.proxy(this.response,this)).catch(t.proxy(this.catch,this))))},catch:function(t){var e;this.setProcessing(!1),this.setLoader(!1),"function"==typeof this.options.error&&this.options.error(),this.$element.hasClass("loaded")&&this.$element.removeClass("loaded"),e={header:t.status,message:t.statusText},console.log("error"),console.log(e)},setContent:function(t,e,o){if(o){var n,i=null;t.find("img").length?(n=!1,t.imagesLoaded({complete:function(){!1===n&&(window.clearTimeout(i),n=!0,this.insertContent(t,e))}.bind(this)}),i=window.setTimeout(function(){!1===n&&(n=!0,this.insertContent(t,e))}.bind(this),3e3)):this.insertContent(t,e)}else this.insertContent(t,e)},insertContent:function(t,e){"prepend"===e?this.$container.prepend(t):e?this.$container.append(t):this.$container.html(t)},response:function(e){if("success"===e.status)if(e.content){var o=t(e.content),n=!1,i=null;o.find("img").length?(o.imagesLoaded({complete:function(){!1===n&&(window.clearTimeout(i),n=!0,this.setResponse(e,o))}.bind(this)}),i=window.setTimeout(function(){!1===n&&(n=!0,this.setResponse(e,o))}.bind(this),3e3)):this.setResponse(e,o)}else this.setResponse(e);else this.setProcessing(!1),this.setLoader(!1),this.options.notificationError&&("modal"===this.options.notificationError?this.notification("warning",e,this.options.notificationError):this.notification("warning",e))},setResponse:function(e,o){var n,i,a;this.setProcessing(!1),this.setLoader(!1),"function"==typeof this.options.afterAjax&&this.options.afterAjax.call(this,e),this.options.loaded&&this.setLoaded(!0),this.getUrl(e)&&(history.replaceState(window.location.href,null,window.location.href),history.pushState(this.getUrl(e),null,this.getUrl(e))),null!==this.$element&&(this.$element.tooltip("hide"),this.$element.tooltip("dispose"),n={relatedTarget:this,response:e},this.$element.trigger(a=t.Event("requireajax.un.show",n)),a.isDefaultPrevented())||(this.$container||this.$element.data("popover"))&&(e.title&&t("title").html(e.title),e.head&&t("head").html(e.head),e.content&&(this.$container&&(this.options.reverse&&this.setReverseScroll(o),this.options.reverse||("container"===this.$container.data("loaded-scroll")?this.setContent(o):!0===this.options.append?this.setContent(o,!0):"prepend"===this.options.append?this.setContent(o,"prepend"):null===this.$element||this.$element.data("popover")||this.setContent(o)),this.options.containerUnwrap&&this.$container.each(function(){t(this).children().unwrap()})),null!==this.$element&&this.$element.data("popover")&&(this.$element.attr("data-content",e.content),this.$element.attr("aria-describedby")&&this.$element.popover("show"))),this.$secondContainer&&this.options.secondContainerRemove?this.$secondContainer.remove():this.$secondContainer&&e.contentSecond&&(i=t(e.contentSecond),this.$secondContainer.html(i),this.options.secondContainerUnwrap&&i.unwrap()),this.historyPage(),this.$popoverReload&&this.$popoverReload.removeClass("loaded").addClass("reloaded").data("loader-overlay",!0).popover("show"),this.options.notification&&("modal"===this.options.notification?this.notification("success",e,this.options.notification):this.notification("success",e)),n={relatedTarget:this,response:e,content:o},this.$container&&this.$container.trigger(t.Event("requireajax.un.shown",n)))},setReverseScroll:function(t){this.setReverseScrollContainer(t)},setReverseScrollContainer:function(e){var o,n;this.$container.html(e),n=this.options.containerClear?t(this.options.containerClear):this.$container,o=e.children().length,n.children().length&&o&&n.scrollTop(n.get(0).scrollHeight)},notification:function(t,e,o){o&&new n({element:null,ajax:!1,append:!1,replaceUrl:!1,header:!!e.header&&e.header,modal:"alert",backdrop:!0,keyboard:!0,focus:!0,show:!0,size:"",target:"popup-modal"},e.message?e.message:e.content)},setLoader:function(t){(this.options.loader.id||this.$popover)&&(!0===t?(this.options.loader.overlay?this.loader=new e({loader:this.options.loader.style?this.options.loader.style:{},idLoader:this.options.loader.idloader,className:this.options.loader.className?this.options.loader.className:""}):this.loader=new e({loader:this.options.loader.style?this.options.loader.style:{position:"relative",display:"block","margin-top":"0"},idLoader:this.options.loader.idloader,className:this.options.loader.className?this.options.loader.className:""}),this.loader.add(this.options.loader.id?this.options.loader.id:this.$popover.find(".popover-content"),this.options.loader.overlay,!1,this.options.loader.prepend),this.$element.data("popover")&&(this.$element.attr("data-content",this.loader.$loader.outerHTML),this.loader.end(),this.$element.popover("show"))):this.loader.end())},getUrl:function(t){return this._url||this.options.replaceUrl&&(!0===this.options.replaceUrl&&t&&t.url?this._url=t.url:!0===this.options.replaceUrl&&null!==this.$element&&this.$element.attr("href")?this._url=this.$element.attr("href"):"string"==typeof this.options.replaceUrl&&(this._url=this.options.replaceUrl)),this._url},historyPage:function(){if(this.getUrl()){var e=window.location.href.replace(location.protocol+"//"+location.host,""),o=t("#wrap").clone();o.find("[data-ajax-request-begin]").html(""),a[e]={title:t("title").html(),body:o.contents().unwrap()}}},isLoaded:function(){return!0===this.loaded},setLoaded:function(t){this.loaded=!0===t,null!==this.$element&&(this.isLoaded()?this.$element.addClass("loaded"):this.$element.removeClass("loaded"))},isProcessing:function(){return!0===this.processing},setProcessing:function(t){this.processing=!0===t,null!==this.$element&&(!0===t?(this.$element.hasClass("dropdown-item")?this.$element.closest(".dropdown-menu").prev().addClass("disabled"):this.$element.addClass("disabled"),this.options.loadingText&&this.$element.html(this.options.loadingText)):(this.$element.hasClass("dropdown-item")?this.$element.closest(".dropdown-menu").prev().removeClass("disabled"):this.$element.removeClass("disabled"),this.options.loadingText&&this.$element.html(this.$element.attr("title"))))}},t(document).on("shown.bs.dropdown","[data-dropdown-loaded]",function(){i(t(this).children('[data-toggle="dropdown"]'),!0,!0)}).on("shown.bs.collapse","[data-collapse-loaded]",function(e){i(t(this),!0,!0)}).on("shown.bs.tab","[data-tab-loaded]",function(e){i(t(e.target),!0,!0)}).on("shown.bs.popover",function(e){i(t(e.target),!0,!0)}).on("click.bs.dropdown","[data-dropdown-loaded] .dropdown-menu",function(t){t.stopPropagation()}).on("click","[data-ajax-request]",function(e){e.preventDefault(),i(t(this),!0)}),t(window).on("popstate",function(e){var o=window.location.href.replace(location.protocol+"//"+location.host,"");a[o]&&(t("title").html(a[o].title),t("#wrap").html(a[o].body.clone()))}),t(function(){(new s).init()}),s});