define(["jquery","loader","mmenu","cookie"],function(e,t,i,a){"use strict";var s=function(t){this.$element=e(t),this.$side=this.$element.find('[data-player-side="true"]'),this.result={},this.params={url:this.$element.find('[data-player-bar-series-list="true"]').data("ajax-url"),method:"GET",dataType:"json",data:{dubbing:null,provider:null,episode:null,id:null}},this.$iframeContainer=this.$element.find(".video-player-online"),this.$mmenu=null,this._width=null,this.$_iframe=e('<iframe src="" frameborder="0" webkitallowfullscreen="true" mozallowfullscreen="true" scrolling="no" allowfullscreen allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"></iframe>'),this.processing=!1,this.loader=null,this.slider=null,this.init()};s.prototype={toggleBar:function(){this.$mmenu=new i("#video-player-side-bar",{speed:400,page:"#wrap",menu:"#video-player-bar-menu",theme:"mm-theme-video-player",widescreen:992,openEvent:"click touchstart",closeEvent:"click touchstart"}),this.$element.on(this.$mmenu._events.open.start,function(){this.$mmenu.setContent(this.$side)}.bind(this)).on(this.$mmenu._events.close.finish,function(){this.$element.find(".video-player-main").after(this.$side)}.bind(this))},tnsToCarousel:function(e,t){this.slider.goTo(t),e.find(".found-number-series").removeClass("found-number-series")},owlToCarousel:function(e,t){if(e.data("owl.carousel")){var i=e.data("owl.carousel").options;e.trigger("to.owl.carousel",[t,i.smartSpeed,!0]),e.find(".found-number-series").removeClass("found-number-series")}},resize:function(){this._width!==this.$iframeContainer.width()&&(this.$_iframe.attr("width",this.$iframeContainer.width()),this.$_iframe.attr("height",this.$iframeContainer.innerHeight()),this._width=this.$iframeContainer.width())},init:function(){this.toggleBar(),e(window).on("resize",this.resize.bind(this)),this.$element.on("change",'select[name="series"]',function(e){var t=e.target;this.$element.find('.video-player-bar-series-list [data-id="'+t.value+'"]').trigger("click")}.bind(this)),this.$element.on("keyup",".video-player-number-series input",function(t){var i=this.$element.find('[data-player-bar-series-list="true"]'),a=i.find('[data-episode="'+t.target.value+'"]');if(a.length)return 13==t.keyCode?(t.target.parentNode.classList.add("enter"),e(t.target.parentNode).popover("hide"),i.find(".found-number-series").removeClass("found-number-series"),this.owlToCarousel(i,parseInt(a.data("episode"))-1),this.tnsToCarousel(i,parseInt(a.data("episode"))-1),this.$element.find('option[value="'+parseInt(a.data("id"))+'"]').prop("selected",!0),void this.$element.find('select[name="series"]').trigger("change")):void(i.data("owl.carousel")&&(a.hasClass("video-player__active")?(t.target.parentNode.classList.add("enter"),e(t.target.parentNode).popover("hide")):(a.addClass("found-number-series"),e(t.target.parentNode).popover("show"))))}.bind(this)).on("blur",".video-player-number-series input",function(t){e(t.target.parentNode).popover("hide")}),e("#video-player-bar-menu").on("click","[data-dubbing]",this.dubbing.bind(this)).on("click","[data-provider]",this.provider.bind(this)).on("click","[data-episode]",this.episode.bind(this)),this.$element.on("click","[data-dubbing]",this.dubbing.bind(this)).on("click","[data-provider]",this.provider.bind(this)).on("click","[data-episode]",this.episode.bind(this)),this.trigger(),this.$element.on("hidden.bs.popover",".video-player-number-series div",function(t){t.target.classList.contains("enter")&&(t.target.classList.remove("enter"),e(t.target).popover("dispose"))}),this.errorOwnPlayer(),e(document).on("requireajax.un.show","[data-watched-id], .my-list-anime",function(e){var t=e.response;"success"===t.status&&this.result[t.id]&&("create"===t.message?this.result[t.id].episodeWatched=!0:this.result[t.id].episodeWatched=!1)}.bind(this)).on("requireajax.un.shown",".my-list-anime",function(e){var t=e.response;if("success"===t.status&&2==t.type)for(var i in this.result)this.result[i].episodeWatched=!0}.bind(this)),this.initTns(),this.censored()},initTns:function(){var e=this.$element.get(0).querySelector("#video-carousel"),t=[];e&&(e.hasAttribute("data-options")&&(t=JSON.parse(e.getAttribute("data-options"))),t.container=e,this.slider=tns(t))},episode:function(t){var i=e(t.currentTarget);if(!this.isProcessing()&&!i.hasClass("video-player__active")){this.$element.find("[data-episode]").removeClass("video-player__active"),i.addClass("video-player__active"),this.params.data.episode=i.data("episode"),this.params.data.id=i.data("id"),this.$element.find('option[value="'+this.params.data.id+'"]').prop("selected",!0);var a=i.data("episode-title"),s=i.data("episode-released"),r=i.data("episode-description"),n=i.data("episode-type");a||(a="---"),s||(s="---"),r?this.$element.find("[data-episode-replace-description]").parent().removeClass("d-none"):(r="",this.$element.find("[data-episode-replace-description]").parent().addClass("d-none")),3==n?this.$element.find("[data-episode-replace-type]").parent().removeClass("d-none"):this.$element.find("[data-episode-replace-type]").parent().addClass("d-none"),this.$element.find("[data-episode-replace-title]").text(a),this.$element.find("[data-episode-replace-released]").text(s),this.$element.find("[data-episode-replace-description]").text(r),this.ajax()}},provider:function(t){var i=e(t.currentTarget);this.isProcessing()||i.hasClass("video-player__active")||(i.siblings().removeClass("video-player__active"),i.addClass("video-player__active"),this.params.data.provider=i.data("provider"),i.data("player")&&(this.$iframeContainer.children(".video-player-online-not").remove(),this.$_iframe.attr("src",i.data("player")),this.$_iframe.attr("width",this.$iframeContainer.width()),this.$_iframe.attr("height",this.$iframeContainer.innerHeight()),this.$iframeContainer.html(this.$_iframe)))},dubbing:function(t){var i=e(t.currentTarget);if(!this.isProcessing()&&!i.hasClass("video-player__active")){i.siblings().removeClass("video-player__active"),i.addClass("video-player__active"),this.params.data.dubbing=i.data("dubbing"),this.$side.find("[data-provide-dubbing]").each(function(t,i){var a=e(i);a.data("provide-dubbing")!=this.params.data.dubbing?a.addClass("d-none"):a.removeClass("d-none")}.bind(this));var a=this.$side.get(0).querySelector('[data-provider="'+this.params.data.provider+'"][data-provide-dubbing="'+this.params.data.dubbing+'"]');a?e(a).trigger("click"):e(this.$side.get(0).querySelector('[data-provide-dubbing="'+this.params.data.dubbing+'"]')).trigger("click")}},errorOwnPlayer:function(){window.addEventListener("message",function(t){if("errorPlayer"===t.data){var i,a=this.$side.get(0).querySelectorAll("[data-provide-dubbing]");for(i in a)if(a[i].getAttribute("data-provide-dubbing")==this.params.data.dubbing&&a[i].getAttribute("data-provider")==this.params.data.provider){if(!a[i].querySelector(".text-danger")){var s=document.createElement("span");s.className="text-danger small ml-1",s.textContent="(error player)",a[i].appendChild(s)}break}for(i in a=this.$side.get(0).querySelectorAll("[data-provide-dubbing]"))if(a[i].getAttribute("data-provide-dubbing")==this.params.data.dubbing&&a[i].getAttribute("data-provider")!=this.params.data.provider){e(a[i]).trigger("click");break}}}.bind(this))},ajax:function(){if(this.setLoader(!0),this.result[this.params.data.id]){this.clearTooltip(),this.$side.html(this.result[this.params.data.id].content),this.setMarkerWatched(this.result[this.params.data.id]),this.trigger(),this.setLoader(!1);var t={relatedTarget:this,response:this.result[this.params.data.id]};this.$side.trigger(e.Event("videoplayer.un.shown",t))}else this.setProcessing(!0),e.ajax(this.params).then(this.response.bind(this)).catch(this.catch.bind(this))},response:function(t){if(this.setProcessing(!1),this.setLoader(!1),"success"===t.status){if(this.clearTooltip(),this.$side.html(t.content),!t.blockEpisode&&t.numVideos>0)this.result[this.params.data.id]=t,this.trigger();else{var i=this.$element.get(0).querySelector('[data-id="'+this.params.data.id+'"]');i&&i.getAttribute("data-player-notvideo")?this.$iframeContainer.html(i.getAttribute("data-player-notvideo")):this.$iframeContainer.html(this.$iframeContainer.data("player-notvideo")),t.blockEpisode&&this.$side.empty()}this.setMarkerWatched(t);var a={relatedTarget:this,response:t};this.$side.trigger(e.Event("videoplayer.un.shown",a))}},setMarkerWatched:function(e){var t=this.$element.get(0).querySelector(".video-player-bar-series-watch");t&&!t.classList.contains("modal.ajax")&&(t.setAttribute("data-watched-id",this.params.data.id),t.setAttribute("data-ajax-url",e.urlEpisodeWatched),e.episodeWatched?(t.classList.add("watched"),t.setAttribute("data-original-title",t.getAttribute("data-watched-text"))):(t.classList.remove("watched"),t.setAttribute("data-original-title",t.getAttribute("data-watch-text"))))},clearTooltip:function(){this.$element.find('[data-toggle="tooltip"]').tooltip("hide").tooltip("dispose")},trigger:function(){if(this.$side.find(".video-player-toggle-item").removeClass("video-player__active"),this.$side.get(0)){if(this.$element.get(0).hasAttribute("data-time")){if(this.$element.get(0).getAttribute("data-time")){this.$element.get(0).getAttribute("data-time");var t=new Date;new Date(t.getTime()-18e4).getTime()}this.$element.get(0).setAttribute("data-time",(new Date).getTime())}var i=this.$side.get(0).querySelector('[data-dubbing="'+this.params.data.dubbing+'"]');i?e(i).trigger("click"):this.$side.get(0).querySelector("[data-dubbing]")?e(this.$side.get(0).querySelector("[data-dubbing]")).trigger("click"):this.$iframeContainer.html(this.$iframeContainer.data("player-notvideo"))}},catch:function(){this.setProcessing(!1),this.setLoader(!1)},setLoader:function(e){!0===e?(this.loader=new t({loader:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%,-50%)","z-index":"110"},idLoader:"uloader",className:"uloader-lg"}),this.$_iframe.remove(),this.$iframeContainer.children(".video-player-online-not").remove(),this.loader.add(this.$iframeContainer.get(0))):this.loader.end()},isProcessing:function(){return!0===this.processing},setProcessing:function(e){this.processing=!0===e},censored:function(){let e=document.querySelector(".overlay-censored");e&&(e.querySelector(".overlay-censored__buttons-no").addEventListener("click",t=>{let i=e.querySelector(".overlay-censored__buttons-block");i.parentNode.removeChild(i);let a=e.querySelector(".overlay-censored-content__description");a.innerHTML=a.getAttribute("data-text"),e.querySelector(".overlay-censored-content__title").classList.add("d-none")}),e.querySelector(".overlay-censored__buttons-yes").addEventListener("click",t=>{e.parentNode.removeChild(e),a.set("censored","true",{expires:1})}))}},e(document).on("requireajax.un.shown","#video-player",function(){new s("#video-player")})});