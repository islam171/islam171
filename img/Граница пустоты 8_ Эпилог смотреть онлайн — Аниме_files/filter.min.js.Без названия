define(["jquery","nouislider","loader","mmenu"],function(t,e,r,i){"use strict";var a={},o=function(){this.$element=document.querySelector("#filter"),this.$element&&(this.$form=null,this.slider=null,this.loader=new r({className:this.$element.getAttribute("data-loaded-classname")?this.$element.getAttribute("data-loaded-classname"):""}),this.processing=!1,this.params={},this.changeTimeoutID=null,this.change=!1,this.ajaxCount=0,this._mmenu=null,this.toggleSlider=this.$element.querySelectorAll(".slider-toggle"),this.init())};return o.prototype={toggleBar:function(){this._mmenu=new i("#mobile-filter-bar",{speed:400,page:"#wrap",menu:"#mobile-filter-bar-menu",theme:"mm-theme-video-player",widescreen:1200,openEvent:"click",closeEvent:"click touchstart"}),t("#mobile-filter-bar").on(this._mmenu._events.open.start,function(){this._mmenu.setContent(this.$element)}.bind(this)).on(this._mmenu._events.close.finish,function(){document.querySelector("#filter-block").appendChild(this.$element)}.bind(this)),t("#mobile-filter-bar-close").on("click",function(e){e.preventDefault(),t("#mobile-filter-bar").trigger("click")})},init:function(){t(document).on("filter.un.shown",function(){this._mmenu.reInitOpenEvent()}.bind(this)),this.toggleBar(),this.$form=this.$element.querySelector("form"),this.$form&&(this.slider=this.$element.querySelector("#slider-range"),this.initSlider(),this.sliderToggle(),this.event())},initSlider:function(){this.slider&&(e.create(this.slider,{range:JSON.parse(this.slider.getAttribute("data-range")),start:JSON.parse(this.slider.getAttribute("data-start")),connect:"true"===this.slider.getAttribute("data-connect"),tooltips:"true"===this.slider.getAttribute("data-tooltips"),step:!!this.slider.getAttribute("data-step")&&parseFloat(this.slider.getAttribute("data-step")),format:{to:function(t){if(this.slider.getAttribute("data-format")){var e=JSON.parse(this.slider.getAttribute("data-format"));if(e.to)return e.to.replace("%s",t)}return t}.bind(this),from:function(t){if(this.slider.getAttribute("data-format")){var e=JSON.parse(this.slider.getAttribute("data-format"));if(e.from)return e.from.replace("%s",t)}return t}.bind(this)},pips:this.slider.getAttribute("data-pips")?JSON.parse(this.slider.getAttribute("data-pips")):{}}),this.silderEvent())},sliderToggle:function(){var r,i;Array.prototype.forEach.call(this.toggleSlider,function(a){i=!1,e.create(a,{orientation:"horizontal",start:a.parentNode.querySelector('[value="and"]:checked')?1:0,range:{min:[0,1],max:1}}),a.noUiSlider.on("update",function(t,e){1===parseInt(t[e])?a.classList.add("and"):a.classList.remove("and")}),a.noUiSlider.on("update",function(e,o){if(!1===i)return i=!0;r=t(a).closest(".form-group").get(0).querySelectorAll('.dropdown-menu [type="checkbox"]:checked'),1===parseInt(e[o])?r&&r.length>1?(a.parentNode.querySelector('[value="or"]').checked=!1,t(a.parentNode.querySelector('[value="and"]')).trigger("click")):(a.parentNode.querySelector('[value="or"]').checked=!1,a.parentNode.querySelector('[value="and"]').checked=!0):r&&r.length>1?(a.parentNode.querySelector('[value="and"]').checked=!1,t(a.parentNode.querySelector('[value="or"]')).trigger("click")):(a.parentNode.querySelector('[value="or"]').checked=!0,a.parentNode.querySelector('[value="and"]').checked=!1)});var o=!1;a.noUiSlider.on("end",function(){o||(1==parseInt(a.noUiSlider.get())?a.noUiSlider.set(0):a.noUiSlider.set(1))}),a.noUiSlider.on("slide",function(){o=!0}),a.noUiSlider.on("update",function(){o=!1}),a.noUiSlider.on("end",function(){o=!1}),a.noUiSlider.on("set",function(){t(a.parentNode).tooltip("hide")})})},silderEvent:function(){this.slider.noUiSlider.on("change",function(t){this.params.from_year=0,this.params.to_year=0;for(var e in t)if(this.params.from_year){if(!this.params.to_year&&(this.params.to_year=parseFloat(t[e].replace(new RegExp("[a-zA-Zа-яА-Я]","g"),"")),this.slider.getAttribute("data-to"))){var r=this.$element.querySelector(this.slider.getAttribute("data-to"));(r&&!r.value&&this.slider.noUiSlider.options.range.max!=this.params.to_year||r&&r.value)&&r.value!=this.params.to_year&&(r.value=this.params.to_year,this.setChange(!0))}}else if(this.params.from_year=parseFloat(t[e].replace(new RegExp("[a-zA-Zа-яА-Я]","g"),"")),this.slider.getAttribute("data-from")){var i=this.$element.querySelector(this.slider.getAttribute("data-from"));(i&&!i.value&&this.slider.noUiSlider.options.range.min!=this.params.from_year||i&&i.value)&&i.value!=this.params.from_year&&(i.value=this.params.from_year,this.setChange(!0))}window.clearTimeout(this.changeTimeoutID),this.changeTimeoutID=window.setTimeout(function(){this.isChange()&&this.ajax()}.bind(this),500)}.bind(this))},event:function(){this.$form.addEventListener("change",function(t){window.clearTimeout(this.changeTimeoutID),this.changeTimeoutID=window.setTimeout(function(){this.ajax()}.bind(this),500),this.setSelectText(t.target)}.bind(this)),Array.prototype.forEach.call(this.$form.querySelectorAll(".label"),function(e){e.addEventListener("click",function(e){var r=e.target.querySelector(".custom-control-input"),i=e.target.querySelector(".form-control-negate");i&&(i.checked=!1,t(e.target).closest(".dropdown-item").get(0).classList.remove("select__option_negated"),e.target.querySelector(".custom-control-description").setAttribute("data-text",r.getAttribute("data-text"))),t(r).trigger("click")})}),Array.prototype.forEach.call(this.$form.querySelectorAll(".select__option-negate"),function(e){e.addEventListener("click",function(e){var r=e.target.parentNode,i=r.querySelector(".custom-control-input"),a=r.querySelector(".form-control-negate");i.checked=!1,a.checked?(r.querySelector(".custom-control-description").setAttribute("data-text",i.getAttribute("data-text")),t(r).closest(".dropdown-item").get(0).classList.remove("select__option_negated")):(r.querySelector(".custom-control-description").setAttribute("data-text",a.getAttribute("data-text")),t(r).closest(".dropdown-item").get(0).classList.add("select__option_negated")),t(a).trigger("click")}.bind(this)),e.addEventListener("mouseenter",function(e){t(e.target).closest(".dropdown-item").get(0).classList.add("select__option_hover-negate")}.bind(this)),e.addEventListener("mouseleave",function(e){t(e.target).closest(".dropdown-item").get(0).classList.remove("select__option_hover-negate")}.bind(this))})},setSelectText:function(e){if("checkbox"===e.type){var r=t(e).closest(".dropdown").get(0);if(r){var i=r.querySelector('[data-toggle="dropdown"]');i&&(i.classList.remove("selected"),i.textContent=i.getAttribute("data-text-default"),Array.prototype.forEach.call(r.querySelectorAll('[type="checkbox"]:checked'),function(t,e){var r=t.parentNode.querySelector(".custom-control-description").getAttribute("data-text");r&&(0==e?(i.classList.add("selected"),i.textContent=r):i.textContent+=", "+r)}.bind(this)))}}},historyPage:function(){var e=window.location.href.replace(location.protocol+"//"+location.host,""),r=t("#wrap").clone();r.find("[data-ajax-request-begin]").html(""),a[e]={title:t("title").html(),body:r.contents().unwrap()}},ajax:function(){"false"!==this.$element.getAttribute("data-filter-ajax")&&(this.setProcessing(!0),this.setLoader(!0),this.setChange(!1),this.ajaxCount+=1,t.ajax({url:this.$form.getAttribute("action"),method:this.$form.getAttribute("method"),dataType:"json",data:t(this.$form).serialize()}).then(this.response.bind(this)).catch(this.catch.bind(this)))},response:function(e){if(this.ajaxCount-=1,!(this.ajaxCount>0)&&(this.setProcessing(!1),this.setLoader(!1),"success"===e.status)){var r=document.querySelector(this.$element.getAttribute("data-container"));r&&(r.innerHTML=e.content);var i=document.querySelector(this.$element.getAttribute("data-title"));if(e.title&&i&&(i.innerHTML=e.title),this.historyPage(),e.url){history.replaceState(window.location.href,null,window.location.href),history.pushState(e.url,null,e.url);var a=document.querySelectorAll('[data-filter-ajax-replace="true"]');a&&Array.prototype.forEach.call(a,function(t){if(t.getAttribute("data-loaded-scroll-url")&&t.setAttribute("data-loaded-scroll-url",e.url),t.getAttribute("data-ajax-url")){var r=t.getAttribute("data-ajax-url");r=r.substr(r.indexOf("sort")),t.setAttribute("data-ajax-url",e.url+"?"+r),"string"==typeof t.getAttribute("data-replace-url")&&t.setAttribute("data-replace-url",e.url+"?"+r)}})}window.myLazyLoad.update(),t(r).trigger(t.Event("filter.un.shown",{relatedTarget:this}))}},catch:function(){this.setProcessing(!1),this.setLoader(!1)},setLoader:function(t){!0===t?(this.loader.end(),this.loader.add("true"===this.$element.getAttribute("data-loader")?this.$element:this.$element.getAttribute("data-loader"),this.$element.getAttribute("data-loader-overlay"))):this.loader.end()},isProcessing:function(){return!0===this.processing},setProcessing:function(t){this.processing=!0===t},isChange:function(){return!0===this.change},setChange:function(t){this.change=!0===t}},new o});