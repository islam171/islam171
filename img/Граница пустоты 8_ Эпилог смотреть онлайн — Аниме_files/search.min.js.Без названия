define(["jquery","loader","popper"],function(e,t){"use strict";function s(){this.$overlay=document.querySelector("#search-overlay"),this.class={search:"#navbar-search-mobile",overlay:"#search-overlay",close:"#search-overlay-close",scrim:"search-scrim"},this.$scrim=null,this.$timeout=null,this.init()}var i=function(t){this.options=e.extend({},i.Default,t),this.$element=e(this.options.inputID),this.$target=this.$element.data("search-target")?this.$element.closest(this.$element.data("search-target")).get(0):this.$element.get(0),this.$search=null,this.$remember=null,this.saveResult={},this.save=!0,this.searchDelay=null,this.$containerSetParams=null,this.ajaxDelay=600,this.msg=!1,this.url="",this.$close=null,this.stop=!1,this._popper=null,this.loader=null,this.init()};return i.Default={inputID:"#search-searchword",minQueryLen:4,searchID:"searchsuggestions",searchContainer:!1,remember:!1,rememberIcon:'<svg class="icon icon-close"><use xlink:href="#icon-close"></use></svg>',params:{url:"",method:"GET",dataType:"json",cache:!1,data:!1},arrow:!1,isToken:!1,arrowClassActive:"active"},i.prototype={init:function(){this.url=this.options.params.url,this.options.searchContainer||e(window).on("resize",this.resize.bind(this)),this.$element.on("input",this.send.bind(this)).on("focus",this.focus.bind(this)).on("blur",this.blur.bind(this))},setParams:function(t,s){this.options.params.data.params=!s&&this.options.params.data.params,this.options.params.data.params=e.extend({},this.options.params.data.params,t)},send:function(e){this.save=e&&"input"===e.type&&!this.options.isToken,e&&"input"===e.type&&this.setParams(this.$element.data("ajax-params"),!0),this.input()},input:function(){var t,s,i;if(this.msg=e.trim(this.$element.val()),window.clearTimeout(this.searchDelay),this.options.minQueryLen<=this.msg.length){if(t={relatedTarget:this},this.$element.trigger(s=e.Event("search.un.input",t)),s.isDefaultPrevented())return;this.options.params.url=this.url.replace("word",this.msg),this.options.params.data[this.$element.attr("name")]=this.msg,this.options.isToken&&(i=[],e(this.$element.data("search-token-container")).children().each(function(t){i[t]=e(this).children("input").val()}),this.options.params.data.ids=i),this.stop=!1,this.searchDelay=window.setTimeout(function(){this.save&&this.getSaveResult(this.msg)&&!this.options.isToken?this.response(this.getSaveResult(this.msg)):this.ajax()}.bind(this),this.ajaxDelay)}else this.options.searchContainer?this.options.remember&&this.msg.length<=0&&this.closeReset():(this.stop=!0,this.removeSearch())},focus:function(){this.$search&&!this.options.searchContainer&&(this.offset(),this.$search.fadeIn("fast"),this._popper.scheduleUpdate())},blur:function(){this.$search&&!this.options.searchContainer&&this.$search.fadeOut("fast")},token:function(){var t,s,i=this;this.$containerSetParams||(this.$containerSetParams=e(this.$element.data("container-set-params"))),this.$element.off("keydown.search.token"),this.$search.off("click.search.token"),this.$search.on("click.search.token","[data-search-token-select]",function(i){i.preventDefault();var a=e(i.currentTarget),n=!0;a.hasClass("selected")||(e(this.$element.data("search-token-container")).children().each(function(){e(this).find("input").val()==a.data("search-token-user-id")&&(n=!1,e(this).find("[data-search-token-remove]").trigger("click"))}),n&&(t=e('<span class="uiToken d-flex align-items-center">                                    <span class="uiTokenText">'+a.data("search-token-user-name")+'</span>                                    <svg class="icon icon-close icon-t-0" role="button" data-search-token-remove="true">                                        <use xlink:href="#icon-close"></use>                                    </svg>                                    <input type="hidden" name="id[]" value="'+a.data("search-token-user-id")+'" />                                </span>'),e(this.$element.data("search-token-container")).append(t)),this.$element.data("search-token-done")&&n&&a.append(this.$element.data("search-token-done")),this.$element.val(""),this.options.searchContainer||this.removeSearch(),this.$containerSetParams&&this.$containerSetParams.length&&(s={ids:[]},e(this.$element.data("search-token-container")).children().each(function(t){s.ids[t]=e(this).children("input").val()}),"hidden"===this.$containerSetParams.attr("type")?this.$containerSetParams.val(JSON.stringify(s)):(this.$containerSetParams.data("ajax-appear-params",s),this.$containerSetParams.attr("data-ajax-appear-params",JSON.stringify(s))),this.$containerSetParams.removeClass("disabled")))}.bind(this)),e(document).on("click.search.token","[data-search-token-remove]",function(t){t.preventDefault();var i=e(t.currentTarget);i.parent().remove(),this.$element.data("search-token-done")&&this.$search.find('[data-search-token-user-id="'+i.parent().find("input").val()+'"] .search-token-done-remove').remove(),s={ids:[]},e(this.$element.data("search-token-container")).children().each(function(t){s.ids[t]=e(this).children("input").val()}),"hidden"===this.$containerSetParams.attr("type")?this.$containerSetParams.val(JSON.stringify(s)):(this.$containerSetParams.data("ajax-appear-params",s),this.$containerSetParams.attr("data-ajax-appear-params",JSON.stringify(s))),this.$containerSetParams&&this.$containerSetParams.length&&this.$containerSetParams.addClass("disabled")}.bind(this)),i.$element.on("keydown.search.token",function(t){8==t.which&&""==e(t.currentTarget).val()&&e(this.$element.data("search-token-container")).children().last().find("[data-search-token-remove]").trigger("click")}.bind(this))},offset:function(){this.$search&&(this.$search.css({width:e(this.$target).outerWidth(!0)}),this._popper||(this._popper=new window.Popper(this.$target,this.$search.get(0),{placement:"bottom",modifiers:{flip:{behavior:"clockwise"}}}),this._popper.scheduleUpdate()))},resize:function(){this.offset()},removeSearch:function(){this.options.searchContainer?(this.$element.off("keydown.search.arrow"),this.$search=null):null!==this.$search&&(this.$element.off("keydown.search.arrow"),this.$search.remove(),null!==this._popper&&this._popper.destroy(),this._popper=null,this.$search=null)},arrow:function(){var t,s=this;this.$search.find("[data-search-item]").first().addClass(this.options.arrowClassActive),this.$search.find("[data-search-item]").on("mouseenter",function(){"ontouchstart"in document.documentElement||(e(this).parent().children().removeClass(s.options.arrowClassActive),e(this).addClass(s.options.arrowClassActive))}).on("mouseenter",function(){"ontouchstart"in document.documentElement||(e(this).parent().children().removeClass(s.options.arrowClassActive),e(this).addClass(s.options.arrowClassActive))}),this.$element.on("keydown.search.arrow",function(e){(t=s.$search.find("[data-search-item]."+s.options.arrowClassActive)).length||s.$search.find("[data-search-item]").first().addClass(s.options.arrowClassActive),40==e.which?t.next().length&&t.removeClass(s.options.arrowClassActive).next().addClass(s.options.arrowClassActive):38==e.which?t.prev().length&&t.removeClass(s.options.arrowClassActive).prev().addClass(s.options.arrowClassActive):13==e.which&&(e.preventDefault(),t.trigger("click"))})},addSearch:function(){this.removeSearch(),this.options.searchContainer?(this.$search=e(this.options.searchContainer),this.$search.html("")):(this.$search=e("<div />"),this.$search.addClass(this.options.searchID))},setLoader:function(s){!0===s?(this.loader&&this.loader.end(),this.closeRemove(),this.options.searchContainer?(this.loader=new t({loader:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%,-50%)","z-index":"110"},idLoader:"uloader"}),e(this.options.searchContainer).html(""),this.loader.add(this.options.searchContainer)):(this.loader=new t({loader:{position:"absolute",top:"50%",right:"10px",transform:"translate(0,-50%)",width:"20px",height:"20px","z-index":"110"},idLoader:"ispinner"}),this.loader.add(this.$element.get(0).parentNode))):(this.loader.end(),this.closeInit())},closeInit:function(){this.options.remember&&!this.$close&&this.msg.length>0&&(this.$close=e('<div class="search-close" role="button"></div>'),this.options.rememberIcon&&this.$close.append(this.options.rememberIcon),this.$close.css({position:"absolute",top:"50%",right:"10px","padding-right":"20px",transform:"translate(0,-50%)",width:"20px","z-index":"110"}),this.$element.css("padding-right","20px"),this.$close.one("click",this.closeReset.bind(this)),this.$element.parent().append(this.$close))},closeReset:function(){var t,s;t={relatedTarget:this,search:this.$search},this.$element.trigger(s=e.Event("search.un.close",t)),s.isDefaultPrevented()||(this.$remember&&(e(this.options.searchContainer).html(this.$remember.html()),this.$remember=null,this.$element.val("")),this.closeRemove(),this.$element.trigger(e.Event("search.un.closed",t)))},closeRemove:function(){this.options.remember&&this.$close&&(this.$close.off("click"),this.$close.remove(),this.$close=null,this.$element.css("padding-right","0"))},ajax:function(){var t,s;t={relatedTarget:this},this.$element.trigger(s=e.Event("search.un.start",t)),s.isDefaultPrevented()||(this.options.remember&&!this.$remember&&(this.$remember=e(this.options.searchContainer).clone()),this.setLoader(!0),e.ajax(this.options.params).then(this.response.bind(this)).catch(this.catch.bind(this)))},response:function(t){var s;if(this.setLoader(!1),"success"===t.status){if(this.setSaveResult(t.word,t),this.stop||this.msg!==t.word&&t.word.length>=this.options.minQueryLen)return;s={response:t,search:this.$search},this.$element.trigger(e.Event("search.un.show",s)),this.addSearch(),this.setContent(t.word),this.options.searchContainer||this.offset(),this.options.searchContainer||(e("body").append(this.$search),this._popper.scheduleUpdate(),this.$search.fadeIn("fast")),this.options.arrow&&this.arrow(),this.options.isToken&&this.token(),s={response:t,search:this.$search},this.$element.trigger(e.Event("search.un.shown",s))}},catch:function(){this.loader.end(),console.log("search error")},setSaveResult:function(e,t){this.saveResult[e.toLowerCase()]=t},getSaveResult:function(e){return this.saveResult[e.toLowerCase()]},getContent:function(e){return this.saveResult[e.toLowerCase()].content},setContent:function(e){this.$search.html(this.getContent(e))}},s.prototype={init:function(){var t=document.querySelector(this.class.search);t&&(t.addEventListener("click",function(t){t.preventDefault(),window.clearTimeout(this.$timeout),"opened"!==this.$overlay.getAttribute("data-state")?(this.$overlay.style.display="block",this.$timeout=window.setTimeout(function(){this.$scrim=document.createElement("div"),this.$scrim.setAttribute("id",this.class.scrim),this.$scrim.classList.add("d-lg-none"),document.querySelector("body").appendChild(this.$scrim),this.$scrim.classList.add("opened"),this.$overlay.setAttribute("data-state","opened"),e(this.$overlay.querySelector("input")).trigger("focus"),document.querySelector("html").classList.add("search-mobile-open")}.bind(this),50)):this.close()}.bind(this)),document.querySelector(this.class.close).addEventListener("click",function(e){e.preventDefault(),window.clearTimeout(this.$timeout),"opened"===this.$overlay.getAttribute("data-state")&&this.close()}.bind(this)))},touchmove:function(t){var s=e(t.target).closest("#search-containe-mobile");(!s.length||s.length&&s.height()>=e(t.target).children().height())&&t.preventDefault()},close:function(){this.$overlay.style.top="auto",this.remove(this.$scrim),this.$overlay.setAttribute("data-state","closed"),document.querySelector("html").classList.remove("search-mobile-open"),this.$timeout=window.setTimeout(function(){this.$overlay.style.display="none"}.bind(this),1e3)},remove:function(e){e&&(e.parentNode.removeChild(e),e=null)}},window.ready(function(){new s}),window.ready(function(){document.querySelector("#navbar-search").addEventListener("click",function(t){t.preventDefault();var s=this.parentNode;s.classList.contains("search-open")?(s.classList.remove("search-open"),s.querySelector(".search").classList.remove("fadeIn")):(s.classList.add("search-open"),s.querySelector(".search").classList.add("fadeIn"),e(s.querySelector("input")).trigger("focus"))})}),i});