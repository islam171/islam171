define(["jquery","loader"],function(e,t){"use strict";var i=function(t){this.options=e.extend({},i.Default,t),this.$element="object"==typeof this.options.element?this.options.element:e(this.options.element),"object"==typeof this.options.container&&this.options.container.length?this.$container=this.options.container:this.options.container&&"string"==typeof this.options.container?this.$container=e(this.options.container):this.$container=this.$element,this.processing=!1,this.loaded=!1,this.loader=null,this.timeVisibleId=null,this.visibleId=[]};return i.Default={element:null,container:!1,loadedScroll:"window",loadedBegin:!1,scrollVisible:!1,scrollVisibleTop:300,page:1,limit:!1,url:!1,requestMethod:"GET",dataType:"json",data:{},append:!1,button:!1,top:100,reverse:!1},i.prototype={init:function(){e('[data-loaded="true"]').each(function(){var t=e(this);t.data("LoadedScrollAjax")||(t.data("LoadedScrollAjax",new i({element:t,container:t.data("loaded-scroll-container"),loadedScroll:t.data("loaded-scroll"),loadedBegin:t.data("loaded-begin"),scrollVisible:t.data("loaded-scroll-visible"),scrollVisibleTop:t.data("loaded-scroll-visible-top")||t.data("loaded-scroll-visible-top")<=0?t.data("loaded-scroll-visible-top"):300,page:t.data("loaded-scroll-page"),limit:t.data("loaded-scroll-limit"),url:t.data("loaded-scroll-url"),requestMethod:t.data("loaded-scroll-method")?t.data("loaded-scroll-method"):"GET",dataType:t.data("loaded-scroll-type")?t.data("loaded-scroll-type"):"json",data:t.data("loaded-scroll-params"),top:t.data("loaded-scroll-top")||t.data("loaded-scroll-top")<=0?t.data("loaded-scroll-top"):100,reverse:t.data("loaded-scroll-reverse")})),t.data("LoadedScrollAjax").scroll())})},destroy:function(){this.$element.off("scroll.un.scrollvisible"),this.$element.off("scroll.un.loadedscroll"),e(window).off("scroll.un.scrollvisible"),e(window).off("scroll.un.loadedscroll")},getParams:function(){if(this.options.url)return this.options.page=this.options.page?this.options.page:0,this.options.page+=1,this.options.data.page=this.options.page,this.options.limit&&(this.options.data.limit=this.options.limit),this.params={url:this.options.url,method:this.options.requestMethod,dataType:this.options.dataType,data:this.options.data},!0},ajaxVisible:function(){var t={};this.visibleId.length&&this.$element.data("loaded-scroll-visible-url")&&(this.$element.data("loaded-scroll-visible-params")&&(t=this.$element.data("loaded-scroll-visible-params")),t.id=this.visibleId,this.visibleId=[],e.ajax({url:this.$element.data("loaded-scroll-visible-url"),method:this.$element.data("loaded-scroll-visible-method"),dataType:"json",data:t}).then(e.proxy(this.responseVisible,this)).catch(e.proxy(this.catch,this)))},responseVisible:function(t){var i;this.setProcessing(!1),"success"===t.status&&(i={response:t},this.$element.trigger(e.Event("loadedscroll.un.visible.ajax",i)))},ajax:function(t){var i,o={relatedTarget:this};!this.isProcessing()&&this.getParams()&&(this.$element.trigger(i=e.Event("loadedscroll.un.start",o)),i.isDefaultPrevented()||(this.setProcessing(!0,t),e.ajax(this.params).then(e.proxy(this.response,this)).catch(e.proxy(this.catch,this))))},catch:function(){this.setProcessing(!1),console.log("error")},response:function(t){var i,o,s,l;if(this.setProcessing(!1),"success"===t.status){if(s={relatedTarget:this,response:t,container:this.$container},this.$element.trigger(l=e.Event("loadedscroll.un.show",s)),l.isDefaultPrevented())return;i=this.$container?this.$container:this.$element,o=e(t.content),this.options.reverse?this.setScrollContainerLoad(i,o,t):i.append(o),this.setLoaded(t.endPage),this.isLoaded()&&(this.options.scrollVisibleTop=0,this.options.button?this.$element.remove():"container"===this.options.loadedScroll?this.$element.off("scroll.un.loadedscroll"):e(window).off("scroll.un.loadedscroll")),this.options.reverse||(s={relatedTarget:this,response:t},i.trigger(e.Event("loadedscroll.un.shown",s)))}else console.log(t.message)},scroll:function(){"container"===this.options.loadedScroll?(this.options.scrollVisible&&(this.$element.css("position","relative"),this.$element.on("scroll.un.scrollvisible",this.scrollVisibleContentAjax.bind(this))),this.isLoaded()||this.$element.on("scroll.un.loadedscroll",this.scrollContainer.bind(this))):(this.options.scrollVisible&&(e(window).off("scroll.un.scrollvisible"),e(window).on("scroll.un.scrollvisible",this.scrollVisibleContentAjax.bind(this))),this.isLoaded()||(e(window).off("scroll.un.loadedscroll"),e(window).on("scroll.un.loadedscroll",this.scrollWindow.bind(this)))),this.options.scrollVisible&&this.scrollVisibleContentAjax(),this.options.loadedBegin?this.$element.one("loadedscroll.un.shown",this.scrollVisibleContentAjax.bind(this)):this.$element.on("requireajax.un.shown",this.scrollVisibleContentAjax.bind(this))},scrollWindow:function(t){this.isLoaded()||this.isProcessing()||this.$element.offset().top-e(window).innerHeight()+this.$element.height()<=e(window).scrollTop()+this.options.top&&this.ajax(!!t&&t.type)},scrollVisibleContentAjax:function(t){var i;(i=this.$element.children("[data-read]")).length&&(i.length||!this.isLoaded()?("container"===this.options.loadedScroll?this.options.reverse?e(i.get().reverse()).each(e.proxy(this.scrollVisibleContainer,this)):i.each(e.proxy(this.scrollVisibleContainer,this)):i.each(e.proxy(this.scrollVisibleWindow,this)),t&&"scroll"===t.type?(window.clearTimeout(this.timeVisibleId),this.timeVisibleId=setTimeout(e.proxy(this.ajaxVisible,this),600)):this.ajaxVisible()):"container"===this.options.loadedScroll?this.$element.off("scroll.un.scrollvisible"):e(window).off("scroll.un.scrollvisible"))},scrollVisibleWindow:function(t,i){var o,s,l=e(i);if(!(l.offset().top-e(window).height()+this.options.scrollVisibleTop<=e(window).scrollTop()))return!1;if(l.data("id")){if(o={relatedTarget:this,id:l.data("id"),item:l},this.$element.trigger(s=e.Event("loadedscroll.un.visible.read",o)),s.isDefaultPrevented())return;this.visibleId.push(l.data("id")),l.removeAttr("data-read")}},scrollVisibleContainer:function(t,i){var o,s,l=e(i);if(this.options.reverse){if(!(l.position().top+this.$element.height()-this.options.scrollVisibleTop>=this.$element.height()))return!1;if(l.data("id")){if(o={relatedTarget:this,id:l.data("id"),item:l},this.$element.trigger(s=e.Event("loadedscroll.un.visible.read",o)),s.isDefaultPrevented())return;this.visibleId.push(l.data("id")),l.removeAttr("data-read")}}else{if(!(l.position().top+this.options.scrollVisibleTop<=this.$element.height()))return!1;if(l.data("id")){if(o={relatedTarget:this,id:l.data("id"),item:l},this.$element.trigger(s=e.Event("loadedscroll.un.visible.read",o)),s.isDefaultPrevented())return;this.visibleId.push(l.data("id")),l.removeAttr("data-read")}}},scrollContainer:function(t){var i=e(t.target);this.isLoaded()||this.isProcessing()||(this.options.reverse?i.scrollTop()<this.options.top&&this.ajax(t.type):i.scrollTop()+this.options.top>=i.prop("scrollHeight")-i.height()&&this.ajax(!!t&&t.type))},setScrollContainerLoad:function(e,t,i){var o,s=null;t.find("img").length?(o=!1,t.imagesLoaded({complete:function(){!1===o&&(window.clearTimeout(s),o=!0,this.setScrollContainer(e,t,i))}.bind(this)}),s=window.setTimeout(function(){!1===o&&(o=!0,this.setScrollContainer(e,t,i))}.bind(this),3e3)):this.setScrollContainer(e,t,i)},setScrollContainer:function(t,i,o){var s,l,a,n;t.prepend(i),t.scrollTop()<200&&(l=i.children().length,(a=t.children()).length&&l&&(isNaN(a.slice(l).length)?t.scrollTop(t.get(0).scrollHeight):(s=0,a.slice(0,l).each(function(){s+=e(this).outerHeight(!0)}),t.scrollTop(s)))),n={relatedTarget:this,response:o},t.trigger(e.Event("loadedscroll.un.shown",n))},isLoaded:function(){return!0===this.loaded},setLoaded:function(e){this.loaded=!0===e},isProcessing:function(e){return e?e.hasClass("loading"):!0===this.processing},setProcessing:function(e,i){this.processing=!0===e,this.isProcessing()?(this.loader=new t({loader:this.$element.data("loader-params")?this.$element.data("loader-params"):{},idLoader:this.$element.data("loader-idloader")&&"scroll"!==i?this.$element.data("loader-idloader"):"spinner",className:this.$element.data("loader-classname")?this.$element.data("loader-classname"):""}),this.options.loadedBegin&&"scroll"!==i&&(this.loader.options.loader=this.$element.data("loader-params")?this.$element.data("loader-params"):{}),this.$element.data("loader")?this.loader.add(!0===this.$element.data("loader")?this.$element.get(0):document.querySelector(this.$element.data("loader")),!1,!1,this.options.reverse):this.$container?(this.$container.addClass("loading"),this.loader.add(this.$container.get(0),!1,!1,this.options.reverse)):(this.$element.addClass("loading"),this.loader.add(this.$element.get(0),!1,!1,this.options.reverse)),this.options.button&&this.$element.addClass("disabled")):(this.$container?this.$container.removeClass("loading"):this.$element.removeClass("loading"),this.options.button&&this.$element.removeClass("disabled"),this.loader&&this.loader.end())}},e(document).on("click","[data-loaded-button]",function(){var t=e(this);t.data("LoadedScrollAjax")||t.data("LoadedScrollAjax",new i({element:t,button:!0,container:t.data("loaded-scroll-container"),scrollVisible:t.data("loaded-scroll-visible"),scrollVisibleTop:t.data("loaded-scroll-visible-top")||t.data("loaded-scroll-visible-top")<=0?t.data("loaded-scroll-visible-top"):300,page:t.data("loaded-scroll-page"),limit:t.data("loaded-scroll-limit"),url:t.data("loaded-scroll-url"),requestMethod:t.data("loaded-scroll-method")?t.data("loaded-scroll-method"):"GET",dataType:t.data("loaded-scroll-type")?t.data("loaded-scroll-type"):"json",data:t.data("loaded-scroll-params"),reverse:t.data("loaded-scroll-reverse")})),t.data("LoadedScrollAjax").ajax()}).on("loadedscroll.un.start","[data-loaded-button]",function(e){var t=e.relatedTarget.$element.find("[data-loading-text]");t.length&&t.text(t.data("loading-text"))}).on("loadedscroll.un.shown",function(e){var t=e.relatedTarget;if(t.options.button){var i=t.$element.find("[data-text]");i.length&&i.text(i.data("text"))}}),e(function(){(new i).init()}),i});